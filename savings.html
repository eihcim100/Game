<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMP Pro Terminal | Elite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        /* Modern Dark Theme Setup */
        :root {
            --bg-dark: #09090b;
            --panel-bg: #18181b;
            --border-color: #27272a;
            --accent-green: #10b981;
            --accent-glow: rgba(16, 185, 129, 0.2);
        }
        body { 
            background-color: var(--bg-dark); 
            background-image: radial-gradient(circle at 50% 0%, #1c1c22, #09090b 80%);
            color: #e4e4e7; 
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif; 
            min-height: 100vh;
        }
        
        /* Glass/Panel Styling */
        .glass-panel { 
            background: rgba(24, 24, 27, 0.6); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        /* Inputs & Controls */
        input, select { 
            background: #09090b; 
            border: 1px solid #3f3f46; 
            color: #fff; 
            transition: all 0.2s; 
        }
        input:focus, select:focus { 
            border-color: var(--accent-green); 
            box-shadow: 0 0 0 2px var(--accent-glow);
            outline: none;
        }

        /* Custom Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.2s ease;
        }
        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); }
        .btn-primary:active:not(:disabled) { transform: translateY(1px); }
        .btn-primary:disabled { background: #27272a; color: #52525b; box-shadow: none; cursor: not-allowed; }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        /* Utility */
        .mono-num { font-variant-numeric: tabular-nums; letter-spacing: -0.02em; }
        .chart-locked div { pointer-events: none !important; }
        
        /* Checkbox styling */
        .custom-check { accent-color: var(--accent-green); width: 1.1rem; height: 1.1rem; cursor: pointer; }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8 max-w-7xl mx-auto flex flex-col gap-6">

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="glass-panel p-5 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition">
                <svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h14c1.1 0 2 .9 2 2v1h-9a2 2 0 00-2 2v8a2 2 0 002 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path></svg>
            </div>
            <div class="text-[11px] text-zinc-400 uppercase font-bold tracking-widest mb-1">Total Equity</div>
            <div id="ui-wallet" class="text-3xl font-bold text-white mono-num tracking-tight">$0.00</div>
            <div class="flex items-center gap-2 mt-4">
                <input type="number" id="deposit-amount" placeholder="500" class="w-20 px-2 py-1 text-xs rounded border-zinc-700 bg-black/50" value="500">
                <button onclick="walletDeposit()" class="text-[10px] bg-zinc-700 hover:bg-zinc-600 px-3 py-1.5 rounded font-bold uppercase transition">Deposit</button>
            </div>
        </div>

        <div class="glass-panel p-5">
            <div class="text-[11px] text-zinc-400 uppercase font-bold tracking-widest mb-1">Session P&L</div>
            <div id="ui-session-pnl" class="text-2xl font-bold text-zinc-500 mono-num">$0.00</div>
            <div class="text-[10px] text-zinc-500 mt-2 font-medium">Realized Gains (Current)</div>
        </div>

        <div class="glass-panel p-5">
            <div class="text-[11px] text-zinc-400 uppercase font-bold tracking-widest mb-1">Lifetime Net</div>
            <div id="ui-lifetime-pnl" class="text-2xl font-bold text-zinc-500 mono-num">$0.00</div>
            <div class="text-[10px] text-zinc-500 mt-2 font-medium">Historical Performance</div>
        </div>

        <div class="glass-panel p-5 flex flex-col justify-between border-zinc-700/50">
            <div>
                <div class="text-[11px] text-zinc-400 uppercase font-bold tracking-widest mb-1">Expiry Timer</div>
                <div id="ui-timer" class="text-3xl font-bold text-blue-500 mono-num">--:--</div>
            </div>
            <button onclick="requestCashout()" class="w-full text-[10px] mt-2 border border-yellow-600/30 text-yellow-500 hover:bg-yellow-500/10 py-1.5 rounded uppercase font-bold tracking-wider transition">Cashout Fund</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
        
        <div class="lg:col-span-8 flex flex-col gap-4">
            <div class="glass-panel p-1 relative h-[500px] overflow-hidden shadow-2xl">
                <div class="absolute top-6 left-6 z-20">
                    <div class="flex items-center gap-2 mb-1">
                        <span id="ui-indicator" class="w-2 h-2 rounded-full bg-zinc-600"></span>
                        <span id="ui-trend" class="text-[10px] font-bold uppercase tracking-wider text-zinc-500">Feed Offline</span>
                    </div>
                    <div id="ui-price" class="text-5xl font-bold text-white mono-num tracking-tighter drop-shadow-lg">$0.00</div>
                </div>
                
                <div id="chartContainer" class="w-full h-full chart-locked opacity-90"></div>
                
                <div class="absolute bottom-4 right-4 text-zinc-800 text-6xl font-black select-none pointer-events-none opacity-20">MMP</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="glass-panel p-5">
                    <div class="flex items-center gap-2 mb-4">
                        <svg class="w-4 h-4 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        <h3 class="text-xs font-bold uppercase text-zinc-300 tracking-widest">Auto-Liquidation</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center group">
                            <span class="text-xs font-medium text-zinc-400 group-hover:text-green-400 transition">Take Profit ($)</span>
                            <div class="flex items-center gap-3">
                                <input type="number" id="input-tp" onchange="syncControls()" class="w-28 text-sm px-3 py-2 rounded-lg bg-black/40 border-zinc-700 focus:border-green-500" placeholder="Target">
                                <input type="checkbox" id="check-tp" onchange="syncControls()" class="custom-check accent-green-500">
                            </div>
                        </div>
                        <div class="h-px bg-zinc-800"></div>
                        <div class="flex justify-between items-center group">
                            <span class="text-xs font-medium text-zinc-400 group-hover:text-red-400 transition">Stop Loss ($)</span>
                            <div class="flex items-center gap-3">
                                <input type="number" id="input-sl" onchange="syncControls()" class="w-28 text-sm px-3 py-2 rounded-lg bg-black/40 border-zinc-700 focus:border-red-500" placeholder="Floor">
                                <input type="checkbox" id="check-sl" onchange="syncControls()" class="custom-check accent-red-500">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-5 flex flex-col items-center justify-center text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-blue-500/5"></div>
                    <div class="text-[10px] text-blue-400 uppercase font-bold tracking-[0.2em] mb-2 z-10">Win Probability</div>
                    <div id="ui-odds" class="text-5xl font-black text-white z-10 mono-num">0%</div>
                    <div class="text-[9px] text-zinc-500 mt-2 z-10 uppercase">Calculated based on Tier & Streak</div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-4 flex flex-col h-full">
            <div class="glass-panel p-6 flex flex-col h-full border-t-4 border-t-zinc-700">
                
                <div class="mb-8">
                    <label class="text-[10px] text-zinc-400 uppercase font-bold block mb-3 tracking-widest">Asset Class Selection</label>
                    <div class="relative">
                        <select id="ui-tier-select" onchange="updateTier(this.value)" class="w-full bg-zinc-900 border border-zinc-700 p-4 pr-8 rounded-xl text-sm appearance-none font-medium cursor-pointer hover:border-zinc-500 transition"></select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-zinc-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>

                <div id="monitor-panel" class="hidden mb-6 p-5 rounded-xl bg-gradient-to-br from-green-900/20 to-black border border-green-500/20 text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-green-500 animate-pulse"></div>
                    <div class="text-[10px] text-green-400 uppercase font-bold tracking-widest mb-1">Live Liquidity</div>
                    <div id="ui-live-val" class="text-4xl font-bold text-white mb-4 mono-num tracking-tight">$0.00</div>
                    <button id="btn-extend" onclick="addTime()" class="w-full text-[10px] bg-zinc-800 text-zinc-300 hover:bg-blue-600 hover:text-white border border-zinc-700 py-2.5 rounded uppercase font-bold transition">Extend 30s ($29)</button>
                </div>

                <div class="mt-auto space-y-3">
                    <button id="btn-buy" onclick="openPosition()" class="btn-primary w-full py-5 rounded-xl font-bold uppercase tracking-[0.15em] text-sm relative overflow-hidden">
                        <span class="relative z-10">Open Position</span>
                    </button>
                    
                    <button id="btn-sell" onclick="sellPosition()" disabled class="btn-danger w-full py-5 rounded-xl font-bold uppercase tracking-[0.15em] text-sm text-white transition disabled:opacity-20 disabled:cursor-not-allowed">
                        Close Position
                    </button>
                </div>

                <div class="flex justify-between items-end pt-8 mt-6 border-t border-zinc-800/50">
                    <button onclick="resetTerminal()" class="text-[10px] text-zinc-600 hover:text-red-500 transition font-bold uppercase tracking-widest flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        Reset
                    </button>
                    <div class="text-right">
                        <div class="text-[9px] text-zinc-700 font-bold uppercase">System Status</div>
                        <div class="flex items-center justify-end gap-1.5 mt-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                            <span class="text-[10px] text-zinc-500 font-bold">ONLINE</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    const TIERS = [
        { id: 0, label: 'MICRO CAP (Cost: $150)', payout: 150, odds: 75, boost: 5 },
        { id: 1, label: 'SMALL CAP (Cost: $200)', payout: 200, odds: 60, boost: 5 },
        { id: 2, label: 'MID CAP (Cost: $300)', payout: 300, odds: 40, boost: 5 },
        { id: 3, label: 'LARGE CAP (Cost: $400)', payout: 400, odds: 30, boost: 5 },
        { id: 4, label: 'MEGA CAP (Cost: $500)', payout: 500, odds: 20, boost: 5 },
        { id: 5, label: 'INSTITUTIONAL (Cost: $1k)', payout: 1000, odds: 15, boost: 2.5 }
    ];

    let state = {
        wallet: 1000,
        pot: 0, 
        sessionPaid: 0,
        sessionRec: 0,
        lifetimePaid: 0,
        lifetimeRec: 0,
        streak: 0,
        tierIdx: 2,
        active: false,
        ticker: 0, // Starts at 0, only sets when opened
        maxRange: 0,
        deadline: 0,
        extUsed: false,
        win: false,
        tp: { on: false, val: 0 },
        sl: { on: false, val: 0 }
    };

    let chart, series;

    function save() { localStorage.setItem('MMP_PRO_TERMINAL', JSON.stringify(state)); }

    function init() {
        const saved = localStorage.getItem('MMP_PRO_TERMINAL');
        if(saved) state = { ...state, ...JSON.parse(saved) };
        
        // Reset active state on load to prevent broken loops
        state.active = false; 

        // Initialize Inputs ONCE. We do not update these in the render loop anymore.
        document.getElementById('input-tp').value = state.tp.val || '';
        document.getElementById('check-tp').checked = state.tp.on;
        document.getElementById('input-sl').value = state.sl.val || '';
        document.getElementById('check-sl').checked = state.sl.on;

        const sel = document.getElementById('ui-tier-select');
        sel.innerHTML = TIERS.map((t, i) => `<option value="${i}">${t.label}</option>`).join('');
        sel.value = state.tierIdx;

        const container = document.getElementById('chartContainer');
        chart = LightweightCharts.createChart(container, {
            layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#52525b' },
            grid: { vertLines: { color: '#27272a' }, horzLines: { color: '#27272a' } },
            crosshair: { mode: 0 }, // Magnet
            handleScroll: false, handleScale: false,
            priceScale: { autoScale: false, minValue: 0, maxValue: 1500, borderVisible: false },
            timeScale: { borderVisible: false, timeVisible: true, secondsVisible: true }
        });
        
        series = chart.addAreaSeries({ 
            lineColor: '#10b981', 
            topColor: 'rgba(16, 185, 129, 0.4)', 
            bottomColor: 'rgba(16, 185, 129, 0.0)', 
            lineWidth: 2 
        });

        setInterval(tickPrice, 600);
        setInterval(updateTimer, 100);
        render();
    }

    function tickPrice() {
        // LOGIC FIX: Completely stop the feed if not active
        if (!state.active) return;

        const step = 18;
        let change = (Math.random() * step * 2) - step;

        const bias = state.win ? (state.maxRange * 0.85) : 10;
        if (state.ticker < bias) change += 8; else change -= 6;
        if (state.ticker > state.maxRange) change = -20;
        if (state.ticker < 0) change = 20;

        state.ticker = Math.max(0, Math.min(1500, state.ticker + change));
        
        series.update({ time: Math.floor(Date.now()/1000), value: state.ticker });
        
        // Auto Close Logic
        if (state.tp.on && state.ticker >= state.tp.val && state.tp.val > 0) sellPosition('TAKE PROFIT EXECUTED');
        if (state.sl.on && state.ticker <= state.sl.val && state.sl.val > 0) sellPosition('STOP LOSS EXECUTED');
        
        render();
    }

    function updateTimer() {
        if (!state.active) {
            document.getElementById('ui-timer').innerText = "--:--";
            return;
        }
        const remaining = Math.max(0, state.deadline - Date.now());
        const secs = Math.ceil(remaining/1000);
        const mm = Math.floor(secs/60).toString().padStart(2,'0');
        const ss = (secs%60).toString().padStart(2,'0');
        document.getElementById('ui-timer').innerText = `${mm}:${ss}`;
        if (remaining <= 0) sellPosition('TIME EXPIRED');
    }

    function openPosition() {
        if (state.wallet < 199) return alert('Insufficient Equity. Minimum $199 required.');
        
        state.wallet -= 199;
        state.sessionPaid += 199;
        state.lifetimePaid += 199;
        state.active = true;
        state.deadline = Date.now() + 60000;
        state.extUsed = false;

        const tier = TIERS[state.tierIdx];
        const currentOdds = Math.min(100, tier.odds + (state.streak * tier.boost));
        state.win = (Math.random() * 100) <= currentOdds;

        const base = state.win ? tier.payout : 30;
        state.maxRange = base + state.pot;

        // Reset chart visual for new trade
        state.ticker = state.win ? (199 + Math.random() * 50) : (Math.random() * 25);
        series.setData([]); // Clear old line
        
        save(); render();
    }

    function sellPosition(reason = '') {
        if (!state.active) return;

        const captured = state.ticker;
        state.wallet += captured;
        state.sessionRec += captured;
        state.lifetimeRec += captured;

        state.pot = Math.max(0, state.maxRange - captured);

        if (state.win) state.streak = 0; else state.streak++;

        state.active = false;
        // Do NOT reset ticker to 250, leave it where it ended so user sees result
        
        save(); render();
        
        // Slight delay on alert so UI updates first
        setTimeout(() => {
            alert(`${reason || 'MARKET EXIT'} \n\nSettled: $${captured.toFixed(2)}`);
        }, 100);
    }

    function requestCashout() {
        if (state.active) return alert('Cannot cashout active position.');
        if (state.pot <= 0) return alert('No stealth fund accumulated to cash out.');
        
        const pct = 0.5 + (Math.random() * 0.5); // 50% to 100%
        const cashValue = state.pot * pct;
        
        const confirmMsg = `CASHOUT REQUEST\n\nLiq. Rate: ${(pct*100).toFixed(0)}%\nValue: $${cashValue.toFixed(2)}\n\nProceed?`;
        
        if (confirm(confirmMsg)) {
            state.wallet += cashValue;
            state.lifetimeRec += cashValue;
            state.pot = 0;
            state.streak = 0;
            state.sessionPaid = 0;
            state.sessionRec = 0;
            save(); render();
        }
    }

    function addTime() {
        if (!state.active || state.extUsed || state.wallet < 29) return;
        state.wallet -= 29;
        state.sessionPaid += 29;
        state.lifetimePaid += 29;
        state.deadline += 30000;
        state.extUsed = true;
        save(); render();
    }

    function syncControls() {
        // Only updates State FROM Input. Never Input FROM State.
        state.tp.on = document.getElementById('check-tp').checked;
        state.tp.val = parseFloat(document.getElementById('input-tp').value) || 0;
        state.sl.on = document.getElementById('check-sl').checked;
        state.sl.val = parseFloat(document.getElementById('input-sl').value) || 0;
        save();
    }

    function walletDeposit() {
        const amt = parseFloat(document.getElementById('deposit-amount').value);
        if (isNaN(amt) || amt <= 0) return;
        state.wallet += amt;
        save(); render();
    }

    function updateTier(idx) {
        if (state.active) return;
        state.tierIdx = parseInt(idx);
        save(); render();
    }

    function resetTerminal() {
        if(confirm("FACTORY RESET: Clear all data?")) {
            localStorage.removeItem('MMP_PRO_TERMINAL');
            location.reload();
        }
    }

    function render() {
        const get = (id) => document.getElementById(id);
        const tier = TIERS[state.tierIdx];
        
        get('ui-wallet').innerText = `$${state.wallet.toFixed(2)}`;
        get('ui-price').innerText = state.active ? `$${state.ticker.toFixed(2)}` : "READY";
        
        const sessionNet = state.sessionRec - state.sessionPaid;
        get('ui-session-pnl').innerText = `${sessionNet >= 0 ? '+' : ''}$${sessionNet.toFixed(2)}`;
        get('ui-session-pnl').className = sessionNet >= 0 ? "text-2xl font-bold text-green-400 mono-num" : "text-2xl font-bold text-red-500 mono-num";
        
        const lifeNet = state.lifetimeRec - state.lifetimePaid;
        get('ui-lifetime-pnl').innerText = `${lifeNet >= 0 ? '+' : ''}$${lifeNet.toFixed(2)}`;
        get('ui-lifetime-pnl').className = lifeNet >= 0 ? "text-2xl font-bold text-blue-400 mono-num" : "text-2xl font-bold text-red-500 mono-num";
        
        const odds = Math.min(100, tier.odds + (state.streak * tier.boost));
        get('ui-odds').innerText = `${odds}%`;

        // Logic for panels
        get('monitor-panel').classList.toggle('hidden', !state.active);
        
        // Live Val update
        get('ui-live-val').innerText = `$${state.ticker.toFixed(2)}`;

        // Button States
        const btnBuy = get('btn-buy');
        btnBuy.disabled = state.active || state.wallet < 199;
        btnBuy.innerHTML = state.active ? 
            `<span class="relative z-10 animate-pulse">Position Active</span>` : 
            `<span class="relative z-10">Open Position ($199)</span>`;
            
        get('btn-sell').disabled = !state.active;
        get('btn-extend').disabled = state.extUsed;

        // Visual Indicator
        get('ui-indicator').className = state.active ? "w-2 h-2 rounded-full bg-green-500 animate-ping" : "w-2 h-2 rounded-full bg-zinc-600";
        get('ui-trend').innerText = state.active ? "Live Feed Active" : "Feed Offline";
        get('ui-trend').className = state.active ? "text-[10px] text-green-500 uppercase font-bold tracking-wider" : "text-[10px] text-zinc-500 uppercase font-bold tracking-wider";

        // IMPORTANT: Removed the lines that were overwriting inputs here.
        // Inputs now maintain their own state in the DOM until the page refreshes.
    }

    window.onload = init;
</script>
</body>
</html>
