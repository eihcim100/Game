<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMP Pro Lite v3.3 | Controls Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background: #050505; color: #fff; font-family: ui-monospace, monospace; }
        .panel { background: #0f0f0f; border: 1px solid #222; border-radius: 12px; }
        .chart-locked div { pointer-events: none !important; }
        input { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 6px 12px; border-radius: 6px; outline: none; }
        input:focus { border-color: #ec4899; }
        .btn-action { transition: all 0.2s; }
        .btn-action:active { transform: scale(0.95); }
        .toggle-checkbox:checked { right: 0; border-color: #f59e0b; }
        .toggle-checkbox:checked + .toggle-label { background-color: #f59e0b; }
        .streak-fill { transition: width 0.3s ease-out, background-color 0.3s; }
        
        @keyframes flashRed {
            0% { background-color: rgba(239, 68, 68, 0); }
            50% { background-color: rgba(239, 68, 68, 0.2); }
            100% { background-color: rgba(239, 68, 68, 0); }
        }
        .crash-anim { animation: flashRed 1s infinite; }
        
        @keyframes flashGreen {
            0% { border-color: #222; }
            50% { border-color: #22c55e; box-shadow: 0 0 10px rgba(34, 197, 94, 0.3); }
            100% { border-color: #222; }
        }
        .spike-anim { animation: flashGreen 0.5s infinite; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-6xl mx-auto">

    <!-- Header Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="panel p-4">
            <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Wallet Balance</div>
            <div id="ui-wallet" class="text-2xl font-bold text-green-400">$0.00</div>
            <div class="flex flex-col gap-2 mt-3">
                <div class="flex gap-1">
                    <input type="number" id="deposit-amount" placeholder="Amt" class="w-full text-xs" value="5000">
                    <button onclick="walletDeposit()" class="text-[10px] bg-green-600 hover:bg-green-500 px-3 py-1 rounded font-bold uppercase btn-action">Deposit</button>
                </div>
                <button onclick="walletWithdraw()" class="text-[9px] text-gray-400 hover:text-white underline text-left">Withdraw All to Bank</button>
            </div>
        </div>
        <div class="panel p-4">
            <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Current Session P&L</div>
            <div id="ui-session-pnl" class="text-2xl font-bold">$0.00</div>
            <div class="text-[9px] text-gray-600 mt-1 uppercase">Active Trade Focus</div>
        </div>
        <div class="panel p-4">
            <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Lifetime P&L</div>
            <div id="ui-lifetime-pnl" class="text-2xl font-bold text-blue-400">$0.00</div>
            <div class="text-[9px] text-gray-600 mt-1 uppercase">Persistent History</div>
        </div>
        <div class="panel p-4 flex flex-col justify-between">
            <div>
                <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Round Timer</div>
                <div id="ui-timer" class="text-2xl font-bold text-blue-500">--:--</div>
            </div>
            <button onclick="requestCashout()" class="text-[10px] bg-yellow-600/20 text-yellow-500 border border-yellow-600/40 hover:bg-yellow-600 hover:text-black p-1 rounded font-bold uppercase btn-action mt-2">Cashout & Exit</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Chart Section -->
        <div class="lg:col-span-2 space-y-4">
            <div id="chart-panel" class="panel p-2 relative h-[450px] overflow-hidden transition-all border border-gray-800">
                <div class="absolute top-4 left-4 z-10 bg-black/80 p-3 rounded-lg border border-gray-800 backdrop-blur-sm flex flex-col gap-2">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span id="ui-indicator" class="w-2 h-2 rounded-full bg-gray-500"></span>
                            <span class="text-[10px] text-gray-400 uppercase font-bold">MMP Data Feed</span>
                        </div>
                        <div id="ui-price" class="text-3xl font-bold mono">$0.00</div>
                        <div id="ui-trend" class="text-[9px] text-gray-600 uppercase font-bold mt-1 tracking-tighter">Market Idle</div>
                    </div>
                    <div id="ui-protection-badge" class="hidden border border-yellow-500/50 bg-yellow-500/10 px-2 py-1 rounded items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 1.944A11.954 11.954 0 012.166 5C2.056 5.649 2 6.319 2 7c0 5.225 3.34 9.67 8 11.317C14.66 16.67 18 12.225 18 7c0-.682-.057-1.35-.166-2.001A11.954 11.954 0 0110 1.944zM11 14a1 1 0 11-2 0 1 1 0 012 0zm0-7a1 1 0 10-2 0v3a1 1 0 102 0V7z" clip-rule="evenodd" />
                        </svg>
                        <span class="text-[9px] font-bold text-yellow-500 uppercase">Protection Active</span>
                    </div>
                </div>
                <div id="chartContainer" class="w-full h-full chart-locked"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="panel p-4">
                    <h3 class="text-[10px] font-bold uppercase mb-4 text-gray-500 tracking-widest">Automation Controls</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-300">Take Profit</span>
                            <div class="flex items-center gap-3">
                                <!-- ADDED oninput="syncControls()" and id check in render -->
                                <input type="number" id="input-tp" oninput="syncControls()" class="w-24 text-xs h-8" placeholder="Target $">
                                <input type="checkbox" id="check-tp" onchange="syncControls()" class="w-4 h-4 accent-green-500">
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-300">Stop Loss</span>
                            <div class="flex items-center gap-3">
                                <!-- ADDED oninput="syncControls()" and id check in render -->
                                <input type="number" id="input-sl" oninput="syncControls()" class="w-24 text-xs h-8" placeholder="Floor $">
                                <input type="checkbox" id="check-sl" onchange="syncControls()" class="w-4 h-4 accent-red-500">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel p-4 flex flex-col justify-center text-center">
                    <div class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Calculated Odds</div>
                    <div id="ui-odds" class="text-4xl font-bold text-blue-400 mt-1">0%</div>
                    
                    <div class="w-full bg-gray-800 h-2 rounded-full mt-2 overflow-hidden relative">
                        <div id="ui-streak-bar" class="h-full bg-pink-600 streak-fill" style="width: 0%"></div>
                    </div>
                    <div id="ui-streak-text" class="text-[9px] text-gray-500 uppercase italic mt-1">Streak Power: 0</div>
                </div>
            </div>
        </div>

        <!-- Terminal Section -->
        <div class="space-y-4">
            <div class="panel p-6 space-y-6 flex flex-col h-full">
                <div>
                    <label class="text-[10px] text-gray-500 uppercase font-bold block mb-2 tracking-widest">Strategy Selection</label>
                    <select id="ui-tier-select" onchange="updateTier(this.value)" class="w-full bg-black border border-gray-700 p-4 rounded-xl text-sm outline-none focus:border-green-500 cursor-pointer mb-4"></select>
                    
                    <div id="insurance-option" class="hidden relative border border-yellow-900/30 bg-yellow-900/10 p-4 rounded-xl">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-xs font-bold text-yellow-500 uppercase mb-1 flex items-center gap-2">
                                    Whale Insurance
                                    <span class="bg-yellow-600 text-black text-[8px] px-1 rounded">VIP</span>
                                </div>
                                <div id="ins-cost-display" class="text-[10px] text-gray-400">Cost: $899</div>
                            </div>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="ins" id="ins-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer left-0"/>
                                <label for="ins" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-700 cursor-pointer"></label>
                            </div>
                        </div>
                        <div class="text-[9px] text-yellow-500/50 mt-2 leading-tight">
                            Pays out ONLY if trade settles below $200. Protects against total loss.
                        </div>
                    </div>
                </div>

                <div id="monitor-panel" class="hidden p-6 rounded-xl bg-green-900/5 border border-green-900/20 text-center">
                    <div class="text-[10px] text-green-500 uppercase font-bold tracking-widest mb-2">Market Liquidity</div>
                    <div id="ui-live-val" class="text-5xl font-bold mb-4 tracking-tighter">$0.00</div>
                    <button id="btn-extend" onclick="addTime()" class="w-full text-[10px] bg-blue-600/10 text-blue-400 border border-blue-600/30 hover:bg-blue-600 hover:text-white py-3 rounded-lg uppercase font-bold btn-action">Add 30s ($29)</button>
                </div>

                <div class="space-y-4 mt-auto">
                    <button id="btn-buy" onclick="openPosition()" class="w-full bg-green-600 hover:bg-green-500 py-5 rounded-xl font-bold uppercase tracking-[0.2em] text-sm transition shadow-lg shadow-green-900/20">Open Position</button>
                    <button id="btn-sell" onclick="sellPosition()" disabled class="w-full bg-red-600 hover:bg-red-500 py-5 rounded-xl font-bold uppercase tracking-[0.2em] text-sm transition disabled:bg-gray-800 disabled:text-gray-600 shadow-lg">Market Exit</button>
                </div>

                <div class="flex justify-between items-center pt-6 border-t border-gray-800">
                    <button onclick="resetTerminal()" class="text-[10px] text-gray-600 hover:text-red-400 transition font-bold uppercase tracking-widest">Reset Terminal</button>
                    <span class="text-[9px] text-gray-800 font-bold uppercase">v3.3 CONTROLS FIXED</span>
                </div>
            </div>
        </div>
    </div>

<script>
    const TIERS = [
        { id: 0, label: 'MICRO CAP (T: $150)', payout: 150, odds: 75, boost: 5 },
        { id: 1, label: 'SMALL CAP (T: $200)', payout: 200, odds: 60, boost: 5 },
        { id: 2, label: 'MID CAP (T: $300)', payout: 300, odds: 40, boost: 5 },
        { id: 3, label: 'LARGE CAP (T: $400)', payout: 400, odds: 30, boost: 5 },
        { id: 4, label: 'MEGA CAP (T: $500)', payout: 500, odds: 20, boost: 5 },
        { id: 5, label: 'INSTITUTIONAL (T: $1k)', payout: 1000, odds: 15, boost: 2.5 }
    ];

    const INS_COSTS = { 4: 899, 5: 1299 };
    const INS_THRESHOLD = 200;

    let state = {
        wallet: 5000, pot: 0, sessionPaid: 0, sessionRec: 0, lifetimePaid: 0, lifetimeRec: 0,
        streak: 0, tierIdx: 4, active: false, ticker: 250, maxRange: 0, deadline: 0,
        startTime: 0, 
        volatilityDestined: false, volatilityHappened: false,
        spikeActive: false,
        extUsed: false, insuranceActive: false, insurancePaid: 0, win: false,
        tp: { on: false, val: 0 }, sl: { on: false, val: 0 }
    };

    let chart, series;

    function save() { localStorage.setItem('MMP_LITE_V3_3', JSON.stringify(state)); }

    function init() {
        const saved = localStorage.getItem('MMP_LITE_V3_3');
        if(saved) state = { ...state, ...JSON.parse(saved) };
        state.active = false;
        state.insuranceActive = false;

        const sel = document.getElementById('ui-tier-select');
        sel.innerHTML = TIERS.map((t, i) => `<option value="${i}">${t.label}</option>`).join('');
        sel.value = state.tierIdx;

        const container = document.getElementById('chartContainer');
        chart = LightweightCharts.createChart(container, {
            layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#444' },
            grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
            handleScroll: false, handleScale: false,
            priceScale: { autoScale: false, minValue: 0, maxValue: 1500, borderVisible: false },
            timeScale: { borderVisible: false, timeVisible: true, secondsVisible: true }
        });
        series = chart.addAreaSeries({ lineColor: '#22c55e', topColor: 'rgba(34,197,94,0.15)', bottomColor: 'transparent', lineWidth: 2 });

        setInterval(tickPrice, 600);
        setInterval(updateTimer, 100);
        
        updateTier(state.tierIdx);
        render();
        
        // Initial control sync
        document.getElementById('input-tp').value = state.tp.val || '';
        document.getElementById('input-sl').value = state.sl.val || '';
    }

    function tickPrice() {
        const step = state.active ? 18 : 2;
        let change = (Math.random() * step * 2) - step;

        if (state.active) {
            // VOLATILITY LOGIC
            const elapsed = Date.now() - state.startTime;
            if (state.win && state.volatilityDestined && !state.volatilityHappened && elapsed > 20000) {
                state.volatilityHappened = true;
                const crashPrice = 202 + Math.random() * 38;
                state.ticker = crashPrice;
                const panel = document.getElementById('chart-panel');
                panel.classList.add('crash-anim');
                setTimeout(() => panel.classList.remove('crash-anim'), 3000);
                document.getElementById('ui-trend').innerText = "‚ö†Ô∏è FLASH CRASH ‚ö†Ô∏è";
                document.getElementById('ui-trend').className = "text-[9px] text-red-500 uppercase font-bold mt-1 animate-pulse";
                return;
            }

            // SPIKE LOGIC
            let bias = 10;
            if (state.win) {
                 bias = state.maxRange * 0.85;
            } else {
                 if (!state.spikeActive && Math.random() < 0.05 && state.pot > 100) {
                     state.spikeActive = true;
                     document.getElementById('chart-panel').classList.add('spike-anim');
                 }
                 if (state.spikeActive && Math.random() < 0.1) {
                     state.spikeActive = false;
                     document.getElementById('chart-panel').classList.remove('spike-anim');
                 }
                 if (state.spikeActive) bias = state.pot * 0.6; else bias = 10 + (state.pot * 0.05); 
            }

            if (state.ticker < bias) change += 8; else change -= 6;
            if (state.ticker > state.maxRange) change = -20;
            if (state.ticker < 0) change = 20;
            if (state.spikeActive) change += 5; 
        } else {
            if (state.ticker > 300) change -= 2;
            if (state.ticker < 200) change += 2;
        }

        if (!state.volatilityHappened || !state.active) {
            state.ticker = Math.max(0, Math.min(1500, state.ticker + change));
        } else {
            state.ticker += (Math.random() * 4) - 2; 
        }

        series.update({ time: Math.floor(Date.now()/1000), value: state.ticker });
        
        if (state.active) {
            if (state.tp.on && state.ticker >= state.tp.val) sellPosition('TAKE PROFIT TRIGGERED');
            if (state.sl.on && state.ticker <= state.sl.val) sellPosition('STOP LOSS TRIGGERED');
        }
        render();
    }

    function updateTimer() {
        if (!state.active) return;
        const remaining = Math.max(0, state.deadline - Date.now());
        const secs = Math.ceil(remaining/1000);
        const mm = Math.floor(secs/60).toString().padStart(2,'0');
        const ss = (secs%60).toString().padStart(2,'0');
        
        const elapsed = Date.now() - state.startTime;
        const timeEl = document.getElementById('ui-timer');
        timeEl.innerText = `${mm}:${ss}`;
        
        if (elapsed > 20000 && state.win && !state.volatilityHappened) {
            timeEl.className = "text-2xl font-bold text-red-500 animate-pulse";
        } else {
             timeEl.className = "text-2xl font-bold text-blue-500";
        }
        
        if (remaining <= 0) sellPosition('EXPIRED');
    }

    function openPosition() {
        let cost = 199;
        let insCost = 0;
        const useIns = document.getElementById('ins-toggle').checked && (state.tierIdx === 4 || state.tierIdx === 5);

        if (useIns) {
            insCost = INS_COSTS[state.tierIdx];
            cost += insCost;
        }

        if (state.wallet < cost) return alert(`Insufficient funds. You need $${cost} (Entry + Insurance).`);
        
        state.wallet -= cost;
        state.sessionPaid += cost;
        state.lifetimePaid += cost;
        
        state.active = true;
        state.startTime = Date.now();
        state.deadline = Date.now() + 60000;
        state.extUsed = false;
        
        state.insuranceActive = useIns;
        state.insurancePaid = insCost;

        const tier = TIERS[state.tierIdx];
        const currentOdds = Math.min(100, tier.odds + (state.streak * tier.boost));
        state.win = (Math.random() * 100) <= currentOdds;
        
        state.volatilityDestined = state.win && (Math.random() < 0.3);
        state.volatilityHappened = false;
        state.spikeActive = false;

        const base = state.win ? tier.payout : 30;
        state.maxRange = base + state.pot;
        
        if (state.win) {
             state.ticker = 199 + Math.random() * 50;
        } else {
             const potBoost = Math.min(165, state.pot * 0.1); 
             state.ticker = (Math.random() * 25) + potBoost; 
        }

        save(); render();
    }

    function sellPosition(reason = '') {
        if (!state.active) return;

        const captured = state.ticker;
        let payout = captured;
        let msg = `Settled at $${captured.toFixed(2)}`;

        if (state.insuranceActive) {
            if (captured < INS_THRESHOLD) {
                const refund = 199 + state.insurancePaid;
                payout += refund;
                msg += `\nüõ°Ô∏è LOSS DETECTED (<$200): $${refund} Refunded!`;
            } else {
                msg += `\n‚ö†Ô∏è TRADE > $200. PREMIUM RETAINED.`;
            }
        }

        state.wallet += payout;
        state.sessionRec += payout;
        state.lifetimeRec += payout;
        state.pot = Math.max(0, state.maxRange - captured);

        if (state.win) state.streak = 0; else state.streak++;

        state.active = false;
        state.insuranceActive = false;
        state.insurancePaid = 0;
        state.ticker = 250;
        document.getElementById('chart-panel').classList.remove('crash-anim', 'spike-anim');
        
        save(); render();
        alert(`${reason || 'SELL ORDER EXECUTED'} | ${msg}`);
    }

    function requestCashout() {
        if (state.active) return alert('Cannot cashout with an open position.');
        const pct = 0.5 + (Math.random() * 0.5); 
        const cashValue = state.pot * pct;
        if (confirm(`CASHOUT REQUEST:\n\nLiquidation Value: $${cashValue.toFixed(2)}\n\nProceed?`)) {
            state.wallet += cashValue;
            state.lifetimeRec += cashValue;
            state.pot = 0;
            state.streak = 0;
            state.sessionPaid = 0;
            state.sessionRec = 0;
            save(); render();
            alert(`ACCOUNT CLOSED: $${cashValue.toFixed(2)} has been credited to your wallet.`);
        }
    }

    function addTime() {
        if (!state.active || state.extUsed || state.wallet < 29) return;
        state.wallet -= 29;
        state.sessionPaid += 29;
        state.lifetimePaid += 29;
        state.deadline += 30000;
        state.extUsed = true;
        save(); render();
    }

    function syncControls() {
        state.tp.on = document.getElementById('check-tp').checked;
        state.tp.val = parseFloat(document.getElementById('input-tp').value) || 0;
        state.sl.on = document.getElementById('check-sl').checked;
        state.sl.val = parseFloat(document.getElementById('input-sl').value) || 0;
        save();
    }

    function walletDeposit() {
        const amt = parseFloat(document.getElementById('deposit-amount').value);
        if (isNaN(amt) || amt <= 0) return;
        state.wallet += amt;
        save(); render();
    }

    function walletWithdraw() {
        if (state.wallet <= 0) return;
        state.lifetimeRec += state.wallet;
        state.wallet = 0;
        save(); render();
        alert("Funds successfully transferred to your external account.");
    }

    function updateTier(idx) {
        if (state.active) return;
        state.tierIdx = parseInt(idx);
        
        const insDiv = document.getElementById('insurance-option');
        const costDiv = document.getElementById('ins-cost-display');
        const isEligible = state.tierIdx === 4 || state.tierIdx === 5;
        
        if (isEligible) {
            insDiv.classList.remove('hidden');
            const cost = INS_COSTS[state.tierIdx];
            costDiv.innerText = `Premium: $${cost}`;
        } else {
            insDiv.classList.add('hidden');
            document.getElementById('ins-toggle').checked = false;
        }

        save(); render();
    }

    function resetTerminal() {
        if(confirm("HARD RESET?")) {
            localStorage.removeItem('MMP_LITE_V3_3');
            location.reload();
        }
    }

    function render() {
        const get = (id) => document.getElementById(id);
        const tier = TIERS[state.tierIdx];
        
        get('ui-wallet').innerText = `$${state.wallet.toFixed(2)}`;
        get('ui-price').innerText = `$${state.ticker.toFixed(2)}`;
        get('ui-live-val').innerText = `$${state.ticker.toFixed(2)}`;
        
        const sessionNet = state.sessionRec - state.sessionPaid;
        get('ui-session-pnl').innerText = `$${sessionNet.toFixed(2)}`;
        get('ui-session-pnl').className = sessionNet >= 0 ? "text-2xl font-bold text-green-400" : "text-2xl font-bold text-red-500";
        
        const lifeNet = state.lifetimeRec - state.lifetimePaid;
        get('ui-lifetime-pnl').innerText = `$${lifeNet.toFixed(2)}`;
        get('ui-lifetime-pnl').className = lifeNet >= 0 ? "text-2xl font-bold text-blue-400" : "text-2xl font-bold text-red-500";
        
        const odds = Math.min(100, tier.odds + (state.streak * tier.boost));
        get('ui-odds').innerText = `${odds}%`;

        const maxStreakVisual = 5;
        const streakPct = Math.min(100, (state.streak / maxStreakVisual) * 100);
        const bar = get('ui-streak-bar');
        bar.style.width = `${streakPct}%`;
        
        if (state.streak >= 3) {
            bar.className = "h-full bg-green-500 streak-fill";
            get('ui-streak-text').innerText = "STREAK POWER: MAXIMAL (POSITIVE EV)";
            get('ui-streak-text').className = "text-[9px] text-green-500 uppercase font-bold mt-1";
        } else {
            bar.className = "h-full bg-pink-600 streak-fill";
            get('ui-streak-text').innerText = `Streak Power: ${state.streak} / ${maxStreakVisual}`;
            get('ui-streak-text').className = "text-[9px] text-gray-500 uppercase italic mt-1";
        }

        get('monitor-panel').classList.toggle('hidden', !state.active);
        
        let buyText = `OPEN POSITION ($199)`;
        if (state.active) buyText = 'POSITION ACTIVE';
        else if (get('ins-toggle').checked && (state.tierIdx===4 || state.tierIdx===5)) {
            buyText = `OPEN PROTECTED ($${199 + INS_COSTS[state.tierIdx]})`;
        }
        get('btn-buy').innerText = buyText;
        get('btn-buy').disabled = state.active;
        get('btn-sell').disabled = !state.active;
        get('btn-extend').disabled = state.extUsed;

        get('ui-indicator').className = state.active ? "w-2 h-2 rounded-full bg-green-500 animate-ping" : "w-2 h-2 rounded-full bg-gray-600";
        if (state.active) {
            if (state.volatilityHappened) {
                 get('ui-trend').innerText = "‚ö†Ô∏è FLASH CRASH ‚ö†Ô∏è";
                 get('ui-trend').className = "text-[9px] text-red-500 uppercase font-bold mt-1 animate-pulse";
            } else if (state.spikeActive) {
                 get('ui-trend').innerText = "‚ö° LIQUIDITY SPIKE ‚ö°";
                 get('ui-trend').className = "text-[9px] text-blue-400 uppercase font-bold mt-1 animate-pulse";
            } else {
                get('ui-trend').innerText = state.win ? "Bullish Trend" : (state.pot > 200 ? "Bearish (Pot Active)" : "Bearish Dump");
                get('ui-trend').className = state.win ? "text-[9px] text-green-500 uppercase font-bold mt-1" : "text-[9px] text-yellow-500 uppercase font-bold mt-1";
            }
        } else {
            get('ui-trend').innerText = "Market Idle";
            get('ui-trend').className = "text-[9px] text-gray-600 uppercase font-bold mt-1";
        }

        get('ui-protection-badge').classList.toggle('hidden', !state.insuranceActive);
        
        // FIX: Check focus before overwriting
        if (document.activeElement !== get('input-tp')) {
            get('input-tp').value = state.tp.val || '';
        }
        get('check-tp').checked = state.tp.on;
        
        if (document.activeElement !== get('input-sl')) {
            get('input-sl').value = state.sl.val || '';
        }
        get('check-sl').checked = state.sl.on;
    }

    window.onload = init;
</script>
</body>
</html>
